<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Matisov X ‚Äî System Core</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neon-blue: #00d2ff;
            --neon-pink: #ff007a;
            --cyber-gold: #f59e0b;
            --void-black: #050505;
            --glass-panel: rgba(10, 15, 25, 0.9);
            --border-glow: rgba(0, 210, 255, 0.2);
        }

        body {
            background-color: var(--void-black);
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
        }

        /* Block 0: Visual Engine & Background */
        #render-engine-bg {
            position: fixed;
            inset: 0;
            background: url('https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/1771154757483~2.png') no-repeat center center;
            background-size: cover;
            filter: brightness(0.3) contrast(1.1) hue-rotate(10deg);
            z-index: -1;
            transform: scale(1.05);
        }

        .cyber-glass {
            background: var(--glass-panel);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glow);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }

        .hud-text { font-family: 'Orbitron', sans-serif; }
        
        .coin-particle {
            position: absolute;
            pointer-events: none;
            z-index: 9999;
            font-weight: 900;
            color: var(--neon-blue);
            text-shadow: 0 0 15px var(--neon-blue);
            animation: floatUp 1s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 1; }
            100% { transform: translateY(-150px) scale(1.5); opacity: 0; }
        }

        /* Screens Transition */
        .system-screen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 50;
            padding: 24px;
            padding-bottom: 120px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            overflow-y: auto;
        }
        .system-screen.active { display: flex; opacity: 1; }

        .nav-btn { transition: transform 0.2s, color 0.2s; }
        .nav-btn.active { color: var(--neon-blue); transform: translateY(-5px); text-shadow: 0 0 10px var(--neon-blue); }

        /* Progress Bar */
        .energy-bar-container {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 10px;
        }
        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), #2563eb);
            box-shadow: 0 0 20px var(--neon-blue);
            transition: width 0.5s linear;
        }
    </style>
</head>
<body>

    <div id="render-engine-bg"></div>

    <div id="app-root" class="flex flex-col h-full p-4 relative z-10">
        
        <header class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter hud-text">
                    MATISOV <span class="text-cyan-400">X</span>
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <div id="connection-dot" class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span id="system-log" class="text-[10px] font-mono text-gray-400 tracking-widest uppercase">
                        SYSTEM ONLINE
                    </span>
                </div>
            </div>
            
            <div class="cyber-glass px-4 py-2 min-w-[140px] text-right">
                <div id="display-balance" class="text-3xl font-black text-white hud-text">0</div>
                <div class="text-[9px] text-cyan-500 font-bold uppercase tracking-widest">MX COINS</div>
            </div>
        </header>

        <main class="flex-grow flex flex-col items-center justify-center relative">
            <div id="click-zone" class="w-72 h-72 relative active:scale-95 transition-transform duration-100 cursor-pointer touch-manipulation">
                <img src="https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/file_00000000f6b4720a8cb3d5825edd6728_011655.png" 
                     class="w-full h-full object-contain drop-shadow-[0_0_50px_rgba(0,210,255,0.3)] pointer-events-none select-none">
            </div>
        </main>

        <div class="mb-24 w-full">
            <div class="flex justify-between text-[10px] font-bold mb-1 uppercase tracking-widest">
                <span class="text-cyan-400 flex items-center gap-1">‚ö° Energy Core</span>
                <span id="display-energy">1000 / 1000</span>
            </div>
            <div class="energy-bar-container">
                <div id="energy-bar" class="energy-fill" style="width: 100%"></div>
            </div>
            <div class="mt-2 flex justify-between text-[10px] text-gray-500 font-mono">
                <span>RECOVERY: +<span id="display-regen">1</span>/SEC</span>
                <span>RANK: <span id="display-rank" class="text-white">NOVICE</span></span>
            </div>
        </div>

        <div class="fixed bottom-6 left-6 right-6 cyber-glass h-16 flex justify-around items-center z-40 rounded-2xl">
            <button onclick="Game.UI.router('battle')" id="nav-battle" class="nav-btn active flex flex-col items-center gap-1 w-16">
                <span class="text-lg">‚öîÔ∏è</span>
                <span class="text-[8px] font-bold uppercase">Core</span>
            </button>
            <button onclick="Game.UI.router('missions')" id="nav-missions" class="nav-btn flex flex-col items-center gap-1 w-16">
                <span class="text-lg">üì°</span>
                <span class="text-[8px] font-bold uppercase">Missions</span>
            </button>
            <button onclick="Game.UI.router('upgrade')" id="nav-upgrade" class="nav-btn flex flex-col items-center gap-1 w-16">
                <span class="text-lg">üî•</span>
                <span class="text-[8px] font-bold uppercase">Boost</span>
            </button>
            <button onclick="Game.UI.router('profile')" id="nav-profile" class="nav-btn flex flex-col items-center gap-1 w-16">
                <span class="text-lg">üë§</span>
                <span class="text-[8px] font-bold uppercase">Profile</span>
            </button>
        </div>
    </div>

    <div id="screen-missions" class="system-screen">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-yellow-500 uppercase hud-text">Neural Tasks</h2>
            <button onclick="Game.UI.router('battle')" class="text-2xl text-gray-400">&times;</button>
        </div>
        <div id="mission-list-container" class="space-y-4">
            </div>
    </div>

    <div id="screen-upgrade" class="system-screen">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-pink-500 uppercase hud-text">Engineering Bay</h2>
            <button onclick="Game.UI.router('battle')" class="text-2xl text-gray-400">&times;</button>
        </div>
        
        <div class="cyber-glass p-5 border-l-4 border-pink-500 mb-6">
            <h3 class="text-lg font-bold">MULTITAP OVERCLOCK</h3>
            <p class="text-xs text-gray-400 mt-1 mb-4">Increases mining power per click.</p>
            <div class="flex justify-between items-end">
                <div class="text-xs font-mono text-pink-300">Level: <span id="lvl-multitap">1</span></div>
                <button onclick="Game.Systems.Economy.buyUpgrade('multitap')" class="bg-pink-600 px-4 py-2 rounded text-xs font-bold uppercase">
                    Upgrade (<span id="cost-multitap">500</span> MX)
                </button>
            </div>
        </div>

        <div class="cyber-glass p-5 border-l-4 border-blue-500 mb-6">
            <h3 class="text-lg font-bold">ENERGY EXPANSION</h3>
            <p class="text-xs text-gray-400 mt-1 mb-4">Increases maximum energy capacity.</p>
            <div class="flex justify-between items-end">
                <div class="text-xs font-mono text-blue-300">Level: <span id="lvl-energy">1</span></div>
                <button onclick="Game.Systems.Economy.buyUpgrade('energy')" class="bg-blue-600 px-4 py-2 rounded text-xs font-bold uppercase">
                    Upgrade (<span id="cost-energy">500</span> MX)
                </button>
            </div>
        </div>
    </div>

    <div id="screen-profile" class="system-screen">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black text-cyan-500 uppercase hud-text">Commander</h2>
            <button onclick="Game.UI.router('battle')" class="text-2xl text-gray-400">&times;</button>
        </div>

        <div id="ton-connect-root" class="w-full flex justify-center mb-8"></div>

        <div class="cyber-glass p-6 text-center mb-6">
            <img id="profile-avatar" src="" class="w-20 h-20 rounded-full mx-auto border-2 border-cyan-500 mb-4">
            <h3 id="profile-name" class="text-xl font-bold uppercase">---</h3>
            <div class="text-[10px] text-gray-500 font-mono mt-2">ID: <span id="profile-id">---</span></div>
        </div>

        <div class="cyber-glass p-4 mb-6">
            <div class="text-xs font-bold text-gray-400 uppercase mb-2">Referral System</div>
            <button onclick="Game.Systems.Referral.copyLink()" class="w-full py-3 bg-white text-black font-bold rounded text-xs uppercase">
                Copy Invite Link (+50k Bonus)
            </button>
            <div class="flex justify-between mt-4">
                <div class="text-center w-1/2 border-r border-gray-700">
                    <div class="text-[10px] text-gray-500">FRIENDS</div>
                    <div id="profile-refs" class="text-xl font-bold">0</div>
                </div>
                <div class="text-center w-1/2">
                    <div class="text-[10px] text-gray-500">EARNED</div>
                    <div id="profile-ref-earned" class="text-xl font-bold">0</div>
                </div>
            </div>
        </div>

        <button onclick="Game.Systems.Web3.buyMiningBot()" class="w-full py-4 border border-yellow-500 text-yellow-500 font-black rounded uppercase hover:bg-yellow-500/10 transition">
            BUY MINING BOT (50 TON)
        </button>
    </div>

    <script>
        /**
         * MATISOV X - SYSTEM CORE 2.0
         * Modular Architecture: 8 Blocks
         * 1. CONFIG & UTILS
         * 2. STATE MANAGEMENT
         * 3. AUDIO ENGINE
         * 4. ECONOMY & MATH
         * 5. PERSISTENCE (SAVE/LOAD)
         * 6. MISSION SYSTEM
         * 7. WEB3 & TELEGRAM API
         * 8. UI CONTROLLER & RENDERER
         */

        /* =========================================
           BLOCK 1: CONFIG & UTILS
           ========================================= */
        const Config = {
            VERSION: '2.1.0',
            CREATOR_ID: 84221176157, // –¢–ó 1: Creator Mode
            MINING_BOT_WALLET: 'UQCT58CCHhHD9EuKIAVaZYIICdnbRdrhtWaVzl_CBqoZHEUP',
            CRYPTO_SALT: 'matisov-x-secure-salt-v1', // –î–ª—è –∞–Ω—Ç–∏-—á—ñ—Ç—É
            LEVELS: {
                multitap: { base: 500, growth: 2.0 }, // –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∏–π —Ä—ñ—Å—Ç —Ü—ñ–Ω–∏
                energy: { base: 500, growth: 1.5 }
            },
            IMAGES: {
                default_avatar: 'https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/file_00000000f6b4720a8cb3d5825edd6728_011655.png'
            }
        };

        const Utils = {
            formatNumber: (num) => Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " "),
            generateHash: (data) => CryptoJS.MD5(JSON.stringify(data) + Config.CRYPTO_SALT).toString(),
            sleep: (ms) => new Promise(r => setTimeout(r, ms))
        };

        /* =========================================
           BLOCK 2: STATE MANAGEMENT (REACTIVE STORE)
           ========================================= */
        const Store = {
            state: {
                balance: 0,
                energy: 1000,
                maxEnergy: 1000,
                multitapLevel: 1,
                energyLevel: 1,
                lastLogin: Date.now(),
                refs: [],
                completedMissions: [],
                isArchitect: false,
                isMiningBotActive: false
            },
            
            // –ì–µ—Ç—Ç–µ—Ä–∏ (–æ–±—á–∏—Å–ª—é–≤–∞–ª—å–Ω—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ)
            get clickPower() {
                let base = 1 + (this.state.multitapLevel * 1.5); // –¢–ó: –§–æ—Ä–º—É–ª–∞ —Å–∏–ª–∏
                if (this.state.isArchitect) base = 5000; // –¢–ó: –†–µ–∂–∏–º –¢–≤–æ—Ä—Ü—è
                return base;
            },

            get regenRate() {
                return 1 + this.state.energyLevel; // –¢–ó: –†–µ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è
            },

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
            commit(key, value) {
                this.state[key] = value;
                Game.UI.render(); // –†–µ–∞–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä
            },

            addBalance(amount) {
                this.state.balance += amount;
                Game.UI.updateBalance();
            }
        };

        /* =========================================
           BLOCK 3: AUDIO ENGINE
           ========================================= */
        const AudioEngine = {
            ctx: null,
            init() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone(freq, type = 'sine', dur = 0.1) {
                if (!this.ctx) this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + dur);
            },
            playTap() { this.playTone(800 + Math.random()*200, 'triangle'); },
            playSuccess() { this.playTone(1200, 'sine', 0.3); },
            playError() { this.playTone(150, 'sawtooth', 0.3); }
        };

        /* =========================================
           BLOCK 4: ECONOMY & MATH SYSTEM
           ========================================= */
        const Economy = {
            processTap(event) {
                if (Store.state.energy < Store.clickPower) {
                    Game.UI.showToast('Energy Critical!', 'error');
                    AudioEngine.playError();
                    return;
                }

                // –õ–æ–≥—ñ–∫–∞
                Store.state.energy -= 1; // –í–∏—Ç—Ä–∞—Ç–∞ –µ–Ω–µ—Ä–≥—ñ—ó —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞
                Store.addBalance(Store.clickPower);
                
                // –ï—Ñ–µ–∫—Ç–∏
                AudioEngine.playTap();
                Game.UI.spawnParticle(event.clientX, event.clientY, `+${Store.clickPower.toFixed(1)}`);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –≥–µ—Ä–æ—è
                gsap.to('#click-zone', { scale: 0.95, duration: 0.05, yoyo: true, repeat: 1 });
            },

            calculateUpgradeCost(type) {
                const level = type === 'multitap' ? Store.state.multitapLevel : Store.state.energyLevel;
                const config = Config.LEVELS[type];
                // –ï–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–π–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞: Base * (Growth ^ Level)
                return Math.floor(config.base * Math.pow(config.growth, level - 1));
            },

            buyUpgrade(type) {
                const cost = this.calculateUpgradeCost(type);
                if (Store.state.balance >= cost) {
                    Store.state.balance -= cost;
                    
                    if (type === 'multitap') Store.state.multitapLevel++;
                    if (type === 'energy') {
                        Store.state.energyLevel++;
                        Store.state.maxEnergy += 500; // –¢–ó: +500 —î–º–Ω–æ—Å—Ç—ñ
                    }
                    
                    AudioEngine.playSuccess();
                    Game.UI.showToast(`${type.toUpperCase()} UPGRADED!`, 'success');
                    Game.Persistence.save();
                    Game.UI.render(); // –û–Ω–æ–≤–∏—Ç–∏ —Ü—ñ–Ω–∏
                } else {
                    Game.UI.showToast(`Need ${Utils.formatNumber(cost)} MX`, 'error');
                    AudioEngine.playError();
                }
            },

            regenLoop() {
                setInterval(() => {
                    if (Store.state.energy < Store.state.maxEnergy) {
                        Store.state.energy = Math.min(Store.state.maxEnergy, Store.state.energy + Store.regenRate);
                        Game.UI.updateEnergy();
                    }
                }, 1000);
            },

            // –û—Ñ–ª–∞–π–Ω –º–∞–π–Ω—ñ–Ω–≥ (–ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –≤ –≥—Ä—É)
            calculateOfflineProfit() {
                const now = Date.now();
                const diff = (now - Store.state.lastLogin) / 1000; // —Å–µ–∫—É–Ω–¥–∏
                if (diff > 60 && Store.state.isMiningBotActive) {
                    // –Ø–∫—â–æ –∫—É–ø–ª–µ–Ω–æ –±–æ—Ç–∞: 15% —Å–∏–ª–∏ —Ç–∞–ø—É –≤ —Å–µ–∫—É–Ω–¥—É
                    const profit = Math.floor(diff * (Store.clickPower * 0.15));
                    if (profit > 0) {
                        Store.addBalance(profit);
                        Game.UI.showModal(`BOT REPORT`, `While you were away, mining bot earned: ${Utils.formatNumber(profit)} MX`);
                    }
                }
                Store.state.lastLogin = now;
            }
        };

        /* =========================================
           BLOCK 5: PERSISTENCE (SECURE SAVE)
           ========================================= */
        const Persistence = {
            storageKey: `mx_save_${window.Telegram.WebApp.initDataUnsafe?.user?.id || 'dev'}`,
            
            save() {
                Store.state.lastLogin = Date.now();
                const dataStr = JSON.stringify(Store.state);
                // –ü—Ä–æ—Å—Ç–µ "—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è" —â–æ–± –Ω–µ –ø—Ä–∞–≤–∏–ª–∏ —Ä—É–∫–∞–º–∏ –≤ localStorage
                const encrypted = btoa(dataStr); 
                const hash = Utils.generateHash(Store.state);
                
                localStorage.setItem(this.storageKey, JSON.stringify({
                    data: encrypted,
                    hash: hash
                }));
            },

            load() {
                const raw = localStorage.getItem(this.storageKey);
                if (!raw) return false;

                try {
                    const parsed = JSON.parse(raw);
                    const decrypted = atob(parsed.data);
                    const data = JSON.parse(decrypted);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—ñ—Å–Ω–æ—Å—Ç—ñ
                    if (Utils.generate
