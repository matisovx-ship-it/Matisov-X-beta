<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Matisov X ‚Äî The Great Expansion</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neon-blue: #00d2ff;
            --neon-pink: #ff007a;
            --cyber-gold: #f59e0b;
            --deep-space: #02040a;
            --glass-core: rgba(5, 10, 20, 0.95);
        }

        /* –¢–ó 1: –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ñ–æ–Ω —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #matisov-bg-engine {
            position: fixed;
            inset: 0;
            background: url('https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/1771154757483~2.png') no-repeat center center;
            background-size: cover;
            filter: brightness(0.4) contrast(1.2);
            z-index: -1;
            transition: transform 0.3s ease-out;
        }

        /* –ï—Ñ–µ–∫—Ç–∏ —Å–∫–ª—è–Ω–∏—Ö –ø–∞–Ω–µ–ª–µ–π */
        .cyber-glass {
            background: var(--glass-core);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(0, 210, 255, 0.15);
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.8), inset 0 0 15px rgba(0, 210, 255, 0.05);
        }

        /* –¢–ó 2: –ì–µ—Ä–æ–π —Ç–∞ –ê–Ω—ñ–º–∞—Ü—ñ—ó –≤–∏–ª—å–æ—Ç—É –º–æ–Ω–µ—Ç */
        #hero-combat-zone {
            position: relative;
            z-index: 100;
            transition: transform 0.06s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            will-change: transform;
        }

        #hero-combat-zone img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 35px rgba(0, 210, 255, 0.4));
        }

        .mx-coin-particle {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            color: var(--neon-blue);
            text-shadow: 0 0 20px var(--neon-blue), 0 0 40px #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* –¢–ó 3: –ú–µ–Ω—é —Ç–∞ –ï–∫—Ä–∞–Ω–∏ (–†–æ–∑—à–∏—Ä–µ–Ω–æ) */
        .game-screen {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: radial-gradient(circle at center, #0a0e14 0%, #000 100%);
            display: none;
            flex-direction: column;
            padding: 25px;
            padding-bottom: 160px;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .game-screen::-webkit-scrollbar { display: none; }
        .screen-visible { display: flex !important; animation: screenFade 0.4s ease-out; }

        @keyframes screenFade {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –¢–ó 3 (–ü—ñ–¥–Ω—è—Ç–∞ —Ç–∞ –∑—Ä—É—á–Ω–∞) */
        .bottom-nav-hub {
            position: fixed;
            bottom: 35px;
            left: 20px;
            right: 20px;
            z-index: 5000;
        }

        .nav-inner {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 5px;
        }

        .nav-trigger {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #4a5568;
        }

        .nav-trigger i { font-size: 22px; transition: 0.3s; }
        .nav-trigger span { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .nav-active { color: var(--neon-blue); filter: drop-shadow(0 0 8px var(--neon-blue)); transform: translateY(-5px); }

        /* –¢–ó: –ü—Ä–æ–∫–∞—á–∫–∞ —Ç–∞ Burning */
        .burn-action-btn {
            background: linear-gradient(135deg, #ff007a 0%, #7a00ff 100%);
            border-radius: 18px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }

        .burn-action-btn::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞–≤–¥–∞–Ω—å */
        .mission-row {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            transition: 0.3s;
        }

        .mission-row:hover { border-color: var(--neon-blue); background: rgba(0, 210, 255, 0.05); }

        /* –ï–Ω–µ—Ä–≥–æ-–±–∞—Ä */
        .energy-wrapper {
            height: 12px;
            background: #000;
            border-radius: 20px;
            padding: 2px;
            border: 1px solid rgba(0, 210, 255, 0.3);
        }

        .energy-fluid {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            box-shadow: 0 0 15px var(--neon-blue);
            transition: width 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }
    </style>
</head>
<body>

    <div id="matisov-bg-engine"></div>

    <div id="game-interface-root" class="flex flex-col h-screen p-6 relative">
        
        <header class="flex justify-between items-start mb-8 z-[100]">
            <div class="space-y-2">
                <h1 class="text-3xl font-black italic tracking-tighter animate__animated animate__fadeInLeft">
                    MATISOV <span class="text-cyan-400">X</span>
                </h1>
                <div id="neural-advisor-box" class="cyber-glass px-4 py-2 flex items-center gap-3 border-l-4 border-pink-500">
                    <div class="w-3 h-3 bg-pink-500 rounded-full animate-pulse shadow-[0_0_10px_#ff007a]"></div>
                    <span id="ai-neural-text" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                        Neural Link: Establishing...
                    </span>
                </div>
            </div>
            
            <div class="text-right cyber-glass p-4 min-w-[120px] animate__animated animate__fadeInRight">
                <div id="mx-balance-display" class="text-3xl font-black text-white italic leading-none mb-1">0</div>
                <div class="text-[10px] text-cyan-500 font-black uppercase tracking-tighter">MX Tokens Core</div>
            </div>
        </header>

        <div class="flex items-center gap-4 mb-8 z-[100] animate__animated animate__fadeIn">
            <div class="relative group">
                <img id="tg-player-photo" src="https://via.placeholder.com/80" class="w-16 h-16 rounded-full border-2 border-cyan-400 p-1 shadow-[0_0_15px_rgba(0,210,255,0.3)]">
                <div class="absolute -bottom-1 -right-1 bg-cyan-500 text-black text-[9px] px-2 py-0.5 font-black rounded uppercase">Active</div>
            </div>
            <div>
                <div id="tg-player-name" class="text-lg font-black text-white uppercase tracking-wider">Samurai Warrior</div>
                <div class="text-[10px] text-gray-500 font-mono">NEURAL ID: <span id="tg-player-id">000000000</span></div>
            </div>
        </div>

        <main class="flex-grow flex items-center justify-center relative" id="combat-click-trigger">
            <div id="hero-combat-zone" class="w-full max-w-[320px]">
                <img src="https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/file_00000000f6b4720a8cb3d5825edd6728_011655.png" alt="Cyber Samurai Core">
            </div>
        </main>

        <div class="mb-32 z-[100]">
            <div class="flex justify-between items-end text-[11px] font-black mb-2 tracking-widest">
                <div class="flex flex-col">
                    <span class="text-cyan-400">‚ö° NEURAL ENERGY</span>
                    <span id="energy-numeric" class="text-white text-sm">1000 / 1000</span>
                </div>
                <div class="text-gray-500 uppercase">Recovery: +5/sec</div>
            </div>
            <div class="energy-wrapper">
                <div id="energy-fluid-fill" class="energy-fluid" style="width: 100%"></div>
            </div>
        </div>

        <div class="bottom-nav-hub">
            <nav class="nav-inner cyber-glass">
                <button onclick="switchSystemScreen('battle')" id="btn-nav-battle" class="nav-trigger nav-active">
                    <span class="text-xl">‚öîÔ∏è</span>
                    <span>–ë—ñ–π</span>
                </button>
                <button onclick="switchSystemScreen('missions')" id="btn-nav-missions" class="nav-trigger">
                    <span class="text-xl">üìú</span>
                    <span>–ú—ñ—Å—ñ—ó</span>
                </button>
                <button onclick="switchSystemScreen('burning')" id="btn-nav-burning" class="nav-trigger">
                    <span class="text-xl">üî•</span>
                    <span>–ë—É—Å—Ç</span>
                </button>
                <button onclick="switchSystemScreen('commander')" id="btn-nav-commander" class="nav-trigger">
                    <span class="text-xl">üë§</span>
                    <span>–ü—Ä–æ—Ñ—ñ–ª—å</span>
                </button>
            </nav>
        </div>
    </div>

    <div id="screen-missions" class="game-screen">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black italic text-yellow-500 uppercase tracking-tighter">Neural Tasks</h2>
            <button onclick="switchSystemScreen('battle')" class="text-4xl text-white font-light">&times;</button>
        </div>
        <div class="space-y-4" id="missions-render-list">
            </div>
    </div>

    <div id="screen-burning" class="game-screen text-center">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black italic text-pink-500 uppercase tracking-tighter">Burning Lab</h2>
            <button onclick="switchSystemScreen('battle')" class="text-4xl text-white font-light">&times;</button>
        </div>
        <div class="cyber-glass p-8 mb-8 border-t-4 border-pink-500">
            <div class="text-6xl mb-6">üî•</div>
            <h3 class="text-2xl font-black mb-4 uppercase">Overclock Neural Link</h3>
            <p class="text-sm text-gray-400 leading-relaxed mb-8">
                –°–ø–∞–ª—é–π—Ç–µ MX –º–æ–Ω–µ—Ç–∏ –¥–ª—è –ø–æ—Å—Ç—ñ–π–Ω–æ—ó –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤–∞—à–æ–≥–æ –≥–µ—Ä–æ—è. –ö–æ–∂–µ–Ω –∞–ø–≥—Ä–µ–π–¥ –∑–±—ñ–ª—å—à—É—î —Å–∏–ª—É —Ç–∞–ø—É –Ω–∞–∑–∞–≤–∂–¥–∏.
            </p>
            <button onclick="executeBurningUpgrade()" class="burn-action-btn w-full py-6 font-black text-lg uppercase shadow-2xl">
                Burn 500,000 MX<br>
                <span class="text-xs opacity-80">+2.5 Power per click</span>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="cyber-glass p-4">
                <div class="text-[10px] text-gray-500 uppercase">Burned Total</div>
                <div id="stats-burned-total" class="text-xl font-bold">0 MX</div>
            </div>
            <div class="cyber-glass p-4">
                <div class="text-[10px] text-gray-400 uppercase">Current Power</div>
                <div id="stats-current-power" class="text-xl font-bold text-cyan-400">1.0</div>
            </div>
        </div>
    </div>

    <div id="screen-commander" class="game-screen text-center">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-3xl font-black italic text-cyan-400 uppercase tracking-tighter">Commander</h2>
            <button onclick="switchSystemScreen('battle')" class="text-4xl text-white font-light">&times;</button>
        </div>
        
        <div id="ton-connect-mount-point" class="mb-8 flex justify-center"></div>

        <div class="cyber-glass p-8 mb-8 text-center relative overflow-hidden">
            <div class="absolute top-0 right-0 p-2 text-[10px] font-black bg-cyan-500 text-black">TOP RANK</div>
            <img id="p-commander-avatar" src="" class="w-28 h-28 rounded-full mx-auto border-4 border-cyan-500 p-1 mb-4 shadow-[0_0_30px_#00d2ff]">
            <h3 id="p-commander-name" class="text-2xl font-black uppercase mb-2">---</h3>
            <p id="p-commander-wallet" class="text-xs text-gray-500 font-mono italic truncate px-4">Wallet: Not Connected</p>
        </div>

        <div class="cyber-glass p-6 text-left mb-8">
            <h4 class="text-xs font-black text-pink-500 uppercase mb-4 tracking-widest">Referral Neural Link (–¢–ó 4)</h4>
            <div id="ref-link-display" class="bg-black/60 p-4 rounded-xl font-mono text-[10px] break-all text-cyan-300 border border-white/5 mb-4 italic">
                https://t.me/Matisov_X_bot?start=...
            </div>
            <button onclick="copyRefToClipboard()" class="w-full py-4 cyber-btn bg-white text-black font-black rounded-xl text-xs uppercase transition-all active:scale-95">
                –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (50k MX –ë–æ–Ω—É—Å)
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="cyber-glass p-5">
                <div class="text-[10px] text-gray-500 uppercase">–ó–∞–ø—Ä–æ—à–µ–Ω–æ –¥—Ä—É–∑—ñ–≤</div>
                <div id="stats-ref-count" class="text-3xl font-black text-white">0</div>
            </div>
            <div class="cyber-glass p-5">
                <div class="text-[10px] text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</div>
                <div class="text-lg font-black text-green-500">ONLINE</div>
            </div>
        </div>
    </div>
    <script>
    /**
     * MATISOV X - CORE NEURAL ENGINE
     * Architect: Gemini Adaptive AI
     */

    // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ Telegram WebApp
    const tg = window.Telegram.WebApp;
    const UID = tg.initDataUnsafe?.user?.id || "local_dev_user";
    const USER_NAME = tg.initDataUnsafe?.user?.first_name || "Samurai";
    const USER_LANG = tg.initDataUnsafe?.user?.language_code || "uk";
    
    // –°—Ç–∞–Ω –≥—Ä–∏ (Data Model)
    let state = {
        balance: parseFloat(localStorage.getItem(`mx_bal_${UID}`)) || 0,
        energy: parseInt(localStorage.getItem(`mx_ene_${UID}`)) || 1000,
        maxEnergy: 1000,
        power: parseFloat(localStorage.getItem(`mx_pwr_${UID}`)) || 1.0,
        burnedTotal: parseFloat(localStorage.getItem(`mx_burned_${UID}`)) || 0,
        refsCount: parseInt(localStorage.getItem(`mx_ref_c_${UID}`)) || 0,
        tasksDone: JSON.parse(localStorage.getItem(`mx_tasks_${UID}`)) || [],
        lastRegen: Date.now()
    };

    // –¢–ó 7: AI –ú–æ–≤–Ω–∞ –±–∞–∑–∞ (–†–æ–∑—à–∏—Ä–µ–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞)
    const AI_DIALECTS = {
        uk: {
            welcome: `–í—ñ—Ç–∞—é, –ö–æ–º–∞–Ω–¥–æ—Ä–µ ${USER_NAME}. –ù–µ–π—Ä–æ–º–µ—Ä–µ–∂—É –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ.`,
            lowEnergy: "–ï–Ω–µ—Ä–≥—ñ—è —è–¥—Ä–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ! –í—ñ–¥–ø–æ—á–∏–Ω—å.",
            taskDone: "–ó–∞–≤–¥–∞–Ω–Ω—è –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ. 1,000,000 MX –¥–æ–¥–∞–Ω–æ –¥–æ —Ç–≤–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞.",
            upgrade: "–ú–æ–Ω–µ—Ç–∏ —Å–ø–∞–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ. –¢–≤—ñ–π —É–¥–∞—Ä —Å—Ç–∞–≤ –ø–æ—Ç—É–∂–Ω—ñ—à–∏–º!",
            clickAdvise: "–ü—Ä–æ–¥–æ–≤–∂—É–π —Ä–∏—Ç–º. –ö–æ–∂–µ–Ω —Ç–∞–ø –Ω–∞–±–ª–∏–∂–∞—î —Ç–µ–±–µ –¥–æ –¥–æ–º—ñ–Ω—É–≤–∞–Ω–Ω—è."
        },
        en: {
            welcome: `Greetings, Commander ${USER_NAME}. Neural link established.`,
            lowEnergy: "Core energy critical! Need regeneration.",
            taskDone: "Mission verified. 1,000,000 MX added to your vault.",
            upgrade: "MX burned successfully. Your tap power is now higher!",
            clickAdvise: "Maintain the rhythm. Every tap builds your empire."
        },
        ru: {
            welcome: `–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, –ö–æ–º–∞–Ω–¥–æ—Ä ${USER_NAME}. –ù–µ–π—Ä–æ—Å–µ—Ç—å –∞–∫—Ç–∏–≤–Ω–∞.`,
            lowEnergy: "–≠–Ω–µ—Ä–≥–∏—è —è–¥—Ä–∞ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É—Ä–æ–≤–Ω–µ! –ñ–¥–∏ –∑–∞—Ä—è–¥–∞.",
            taskDone: "–ó–∞–¥–∞–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ. 1,000,000 MX –∑–∞—á–∏—Å–ª–µ–Ω–æ.",
            upgrade: "–ú–æ–Ω–µ—Ç—ã —Å–æ–∂–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ. –¢–≤–æ–π —É–¥–∞—Ä —Å—Ç–∞–ª –º–æ—â–Ω–µ–µ!",
            clickAdvise: "–î–µ—Ä–∂–∏ —Ä–∏—Ç–º. –ö–∞–∂–¥—ã–π —Ç–∞–ø –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç —Ç–µ–±—è –∫ —Ü–µ–ª–∏."
        }
    };

    // TON Connect UI –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (–¢–ó 5)
    const tonConnectUI = new TONConnectUI.TonConnectUI({
        manifestUrl: 'https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/manifest.json',
        buttonRootId: 'ton-connect-mount-point'
    });

    /**
     * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –°–∏—Å—Ç–µ–º
     */
    function initNeuralCore() {
        tg.expand();
        tg.ready();
        tg.enableClosingConfirmation();

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UI –∑ Telegram (–¢–ó 6)
        const user = tg.initDataUnsafe?.user;
        document.getElementById('tg-player-name').innerText = USER_NAME.toUpperCase();
        document.getElementById('p-commander-name').innerText = USER_NAME.toUpperCase();
        document.getElementById('tg-player-id').innerText = UID;
        document.getElementById('ref-link-display').innerText = `https://t.me/Matisov_X_bot?start=${UID}`;

        if (user?.photo_url) {
            document.getElementById('tg-player-photo').src = user.photo_url;
            document.getElementById('p-commander-avatar').src = user.photo_url;
        } else {
            document.getElementById('p-commander-avatar').src = 'https://raw.githubusercontent.com/matisovx-ship-it/Matisov-X-beta/main/file_00000000f6b4720a8cb3d5825edd6728_011655.png';
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ —Ç–∞–ø—É (–¢–ó 2)
        const combatArea = document.getElementById('combat-click-trigger');
        combatArea.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            processTapAction(e);
        });

        // –°–ª—É—Ö–∞—á –≥–∞–º–∞–Ω—Ü—è
        tonConnectUI.onStatusChange(wallet => {
            if (wallet) {
                const addr = wallet.account.address;
                document.getElementById('p-commander-wallet').innerText = `TON: ${addr.slice(0, 8)}...${addr.slice(-8)}`;
                aiSpeak('Neural link with wallet secured.');
            }
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–∞ —Ñ—Ä–∞–∑–∞ AI
        const langData = AI_DIALECTS[USER_LANG] || AI_DIALECTS.en;
        aiSpeak(langData.welcome);

        updateVisualStats();
        startRegenerationLoop();
        checkReferralEntry();
    }

    /**
     * –¢–ó 2: –õ–æ–≥—ñ–∫–∞ –¢–∞–ø—É –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
     */
    function processTapAction(e) {
        if (state.energy < state.power) {
            aiSpeak(AI_DIALECTS[USER_LANG]?.lowEnergy || "No energy!");
            tg.HapticFeedback.notificationOccurred('warning');
            return;
        }

        // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
        state.balance += state.power;
        state.energy -= 1;

        // –í—ñ–∑—É–∞–ª –≥–µ—Ä–æ—è
        const heroNode = document.getElementById('hero-combat-zone');
        heroNode.style.transform = 'scale(0.94) rotate(-1deg)';
        setTimeout(() => heroNode.style.transform = 'scale(1) rotate(0)', 60);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–∞—Å—Ç–∏–Ω–∫–∏ MX (–ú–æ–Ω–µ—Ç–∏)
        createMXParticle(e.clientX, e.clientY);

        // –§—ñ–¥–±–µ–∫
        tg.HapticFeedback.impactOccurred('medium');
        
        // –†–∞–Ω–¥–æ–º–Ω–∞ –ø–æ—Ä–∞–¥–∞ AI
        if (Math.random() > 0.98) {
            aiSpeak(AI_DIALECTS[USER_LANG]?.clickAdvise || "Keep going!");
        }

        updateVisualStats();
        saveGameState();
    }

    function createMXParticle(x, y) {
        const p = document.createElement('div');
        p.className = 'mx-coin-particle';
        p.style.left = `${x}px`;
        p.style.top = `${y}px`;
        p.innerHTML = `<span style="font-size: 28px;">ü™ô</span><span style="font-size: 14px;">+${state.power.toFixed(1)}</span>`;
        document.body.appendChild(p);

        gsap.to(p, {
            y: -180,
            x: x + (Math.random() - 0.5) * 100,
            opacity: 0,
            scale: 2.2,
            duration: 0.8,
            ease: "power2.out",
            onComplete: () => p.remove()
        });
    }

    /**
     * AI Advisor Voice (–¢–ó 7)
     */
    function aiSpeak(text) {
        const aiLabel = document.getElementById('ai-neural-text');
        aiLabel.classList.remove('animate-pulse');
        aiLabel.innerText = text;
        
        // –ï—Ñ–µ–∫—Ç "–¥—Ä—É–∫—É" –∞–±–æ –∑–º—ñ–Ω–∏
        gsap.fromTo(aiLabel, { opacity: 0, y: 5 }, { opacity: 1, y: 0, duration: 0.3 });
        setTimeout(() => aiLabel.classList.add('animate-pulse'), 500);
    }

    /**
     * –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
     */
    function updateVisualStats() {
        document.getElementById('mx-balance-display').innerText = Math.floor(state.balance).toLocaleString();
        document.getElementById('energy-numeric').innerText = `${state.energy} / ${state.maxEnergy}`;
        
        const energyPercent = (state.energy / state.maxEnergy) * 100;
        document.getElementById('energy-fluid-fill').style.width = `${energyPercent}%`;

        // –ü—Ä–æ—Ñ—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ
        document.getElementById('stats-current-power').innerText = state.power.toFixed(1);
        document.getElementById('stats-burned-total').innerText = Math.floor(state.burnedTotal).toLocaleString() + " MX";
        document.getElementById('stats-ref-count').innerText = state.refsCount;
        
        // –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É –µ–Ω–µ—Ä–≥—ñ—ó
        if (energyPercent < 20) {
            document.getElementById('energy-fluid-fill').style.background = 'var(--neon-pink)';
        } else {
            document.getElementById('energy-fluid-fill').style.background = 'linear-gradient(90deg, #00d2ff, #3a7bd5)';
        }
    }

    /**
     * –¢–ó 4: –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∏–π –≤—Ö—ñ–¥
     */
    function checkReferralEntry() {
        const params = new URLSearchParams(window.location.search);
        const refOwner = params.get('start');
        
        if (refOwner && !localStorage.getItem(`mx_ref_claimed_${UID}`)) {
            state.balance += 50000;
            localStorage.setItem(`mx_ref_claimed_${UID}`, 'true');
            tg.showAlert("Neural Bonus: –í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 50,000 MX –∑–∞ –ø–µ—Ä–µ—Ö—ñ–¥ –ø–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—é!");
            updateVisualStats();
        }
    }

    function startRegenerationLoop() {
        setInterval(() => {
            if (state.energy < state.maxEnergy) {
                state.energy = Math.min(state.maxEnergy, state.energy + 5);
                updateVisualStats();
            }
        }, 1200);
    }

    function saveGameState() {
        localStorage.setItem(`mx_bal_${UID}`, state.balance);
        localStorage.setItem(`mx_ene_${UID}`, state.energy);
        localStorage.setItem(`mx_pwr_${UID}`, state.power);
        localStorage.setItem(`mx_burned_${UID}`, state.burnedTotal);
        localStorage.setItem(`mx_ref_c_${UID}`, state.refsCount);
    }
            </script>
             <script>
/* =========================================================
   MATISOV X ‚Äî BLOCK 3 (USER MENU ‚Ä¢ CLAIM ‚Ä¢ DEX/TON ‚Ä¢ REF)
   Drop-in replacement for your 3rd block.
   Requires: tg, UID, state, saveGameState(), updateVisualStats(),
             aiSpeak(), AI_DIALECTS, USER_LANG, initNeuralCore()
   ========================================================= */

const REF_CFG = {
  levels: [
    { lvl: 1, reward: 50000 },   // friend joined (direct)
    { lvl: 2, reward: 20000 },   // friend of friend
    { lvl: 3, reward: 10000 }    // 3rd line
  ],
  cooldownKey: (uid) => `mx_ref_used_${uid}`,
  inviterKey: (uid) => `mx_inviter_${uid}`,
  profileKey: (uid) => `mx_profile_${uid}`,
  shareLink: (uid) => `https://t.me/Matisov_X_bot?start=${uid}`
};

const CLAIM_CFG = {
  lastClaimKey: (uid) => `mx_last_claim_${uid}`,
  claimableKey: (uid) => `mx_claimable_${uid}`,
  baseRatePerSec: 0,            // if you want passive mining, set >0
  botRatePercent: 0.15          // Mining Bot: 15% of tap power per second
};

const DEX_CFG = {
  dex: [
    { id: "dedust", title: "DeDust", url: "https://app.dedust.io" },
    { id: "stonfi", title: "STON.fi", url: "https://app.ston.fi" }
  ],
  wallets: [
    { id: "tonkeeper", title: "Tonkeeper", url: "https://tonkeeper.com" },
    { id: "tonhub", title: "Tonhub", url: "https://tonhub.com" }
  ],
  withdraw: {
    minMX: 10000000,
    feePercent: 0.25,
    gasTon: 0.05,
    receiver: "UQCT58CCHhHD9EuKlAVaZYlICdnbRdrhtWaVzl_CBqoZHEUP"
  }
};

const MISSION_DATABASE = [
  { id: 'task_tg_ch', title: 'Matisov X Channel', reward: 1000000, url: 'https://t.me/Matisov_X', icon: 'üì°' },
  { id: 'task_tg_group', title: 'Cyber Community Chat', reward: 1000000, url: 'https://t.me/MatisovX', icon: 'üí¨' },
  { id: 'task_yt', title: 'YouTube Neural Hub', reward: 1000000, url: 'https://www.youtube.com/@MatisovX', icon: 'üì∫' },
  { id: 'task_ig', title: 'Instagram Matrix', reward: 1000000, url: 'https://www.instagram.com/matisov.x', icon: 'üì∏' },
  { id: 'task_tw', title: 'X Intelligence (Twitter)', reward: 1000000, url: 'https://x.com/matisovx', icon: 'üê¶' }
];

/* =========================
   REQUIRED STATE EXTENSIONS
   ========================= */
(function ensureState(){
  if (!state.tasksDone) state.tasksDone = JSON.parse(localStorage.getItem(`mx_tasks_${UID}`) || "[]");
  if (!state.ref) state.ref = JSON.parse(localStorage.getItem(`mx_ref_state_${UID}`) || "{}");
  if (!state.ref.levelsPaid) state.ref.levelsPaid = [];
  if (!state.ref.myInviter) state.ref.myInviter = localStorage.getItem(REF_CFG.inviterKey(UID)) || null;

  const savedProfile = JSON.parse(localStorage.getItem(REF_CFG.profileKey(UID)) || "{}");
  state.profile = {
    nickname: savedProfile.nickname || (tg?.initDataUnsafe?.user?.first_name || "Cyber Samurai"),
    avatar: savedProfile.avatar || (tg?.initDataUnsafe?.user?.photo_url || "")
  };

  state.wallet = JSON.parse(localStorage.getItem(`mx_wallet_${UID}`) || "{}");
  state.wallet.connected = !!state.wallet.connected;
  state.wallet.address = state.wallet.address || "";
  state.premiumBot = JSON.parse(localStorage.getItem(`mx_premium_bot_${UID}`) || "false");

  const last = parseInt(localStorage.getItem(CLAIM_CFG.lastClaimKey(UID)) || "0");
  if (!Number.isFinite(last) || last <= 0) localStorage.setItem(CLAIM_CFG.lastClaimKey(UID), Date.now().toString());
  const claimable = parseFloat(localStorage.getItem(CLAIM_CFG.claimableKey(UID)) || "0");
  if (!Number.isFinite(claimable) || claimable < 0) localStorage.setItem(CLAIM_CFG.claimableKey(UID), "0");
})();

/* =========================
   MENU: CLAIM COINS (REAL)
   ========================= */
function computeClaimableNow() {
  const now = Date.now();
  const last = parseInt(localStorage.getItem(CLAIM_CFG.lastClaimKey(UID)) || now.toString());
  const seconds = Math.max(0, Math.floor((now - last) / 1000));

  const tapPower = Number(state.power || 1);
  const botRate = state.premiumBot ? (tapPower * CLAIM_CFG.botRatePercent) : 0;
  const baseRate = CLAIM_CFG.baseRatePerSec;

  const earned = seconds * (baseRate + botRate);
  const stored = parseFloat(localStorage.getItem(CLAIM_CFG.claimableKey(UID)) || "0") || 0;

  return { claimable: stored + earned, seconds };
}

function tickClaimable() {
  const now = Date.now();
  const last = parseInt(localStorage.getItem(CLAIM_CFG.lastClaimKey(UID)) || now.toString());
  const seconds = Math.max(0, Math.floor((now - last) / 1000));
  if (seconds <= 0) return;

  const { claimable } = computeClaimableNow();
  localStorage.setItem(CLAIM_CFG.claimableKey(UID), String(claimable));
  localStorage.setItem(CLAIM_CFG.lastClaimKey(UID), String(now));

  const el = document.getElementById("ui-claimable");
  if (el) el.textContent = Math.floor(claimable).toLocaleString() + " MX";
}

function claimCoins() {
  const { claimable } = computeClaimableNow();
  const amount = Math.floor(claimable);

  if (amount <= 0) {
    tg?.showAlert?.("Nothing to claim yet.");
    tg?.HapticFeedback?.notificationOccurred?.("error");
    return;
  }

  state.balance += amount;

  localStorage.setItem(CLAIM_CFG.claimableKey(UID), "0");
  localStorage.setItem(CLAIM_CFG.lastClaimKey(UID), String(Date.now()));

  saveGameState();
  updateVisualStats();

  const el = document.getElementById("ui-claimable");
  if (el) el.textContent = "0 MX";

  aiSpeak(AI_DIALECTS[USER_LANG]?.upgrade || "Claim successful. Balance updated.");
  tg?.showAlert?.(`Claimed: ${amount.toLocaleString()} MX`);
  tg?.HapticFeedback?.notificationOccurred?.("success");
}

/* =========================
   TON / DEX CONNECT (UI)
   ========================= */
function openDexList() {
  const buttons = DEX_CFG.dex.map(d => ({ type: "default", text: d.title, id: d.id }));
  buttons.push({ type: "cancel", text: "Close" });

  tg?.showPopup?.(
    { title: "DEX on TON", message: "Choose exchange:", buttons },
    (btnId) => {
      const item = DEX_CFG.dex.find(x => x.id === btnId);
      if (!item) return;
      tg.openLink(item.url);
    }
  );
}

function openWalletList() {
  const buttons = DEX_CFG.wallets.map(w => ({ type: "default", text: w.title, id: w.id }));
  buttons.push({ type: "cancel", text: "Close" });

  tg?.showPopup?.(
    { title: "Wallets", message: "Choose wallet:", buttons },
    (btnId) => {
      const item = DEX_CFG.wallets.find(x => x.id === btnId);
      if (!item) return;
      tg.openLink(item.url);
    }
  );
}

/* NOTE:
   Real wallet connect + on-chain withdraw MUST be validated by backend or TON Connect.
   This block sends a request to your bot/backend via tg.sendData() for real processing. */
function requestWithdrawMX() {
  const amountStr = prompt(`Withdraw MX (min ${DEX_CFG.withdraw.minMX.toLocaleString()}):`, `${DEX_CFG.withdraw.minMX}`);
  if (!amountStr) return;

  const amount = Math.floor(Number(amountStr));
  if (!Number.isFinite(amount) || amount <= 0) return tg?.showAlert?.("Invalid amount.");
  if (amount < DEX_CFG.withdraw.minMX) return tg?.showAlert?.("Amount below minimum.");
  if (state.balance < amount) return tg?.showAlert?.("Not enough MX balance.");

  const feeMX = Math.ceil(amount * (DEX_CFG.withdraw.feePercent / 100));
  const receiveMX = Math.max(0, amount - feeMX);

  const ok = confirm(
    `Withdraw request:\n\n` +
    `Amount: ${amount.toLocaleString()} MX\n` +
    `DEX fee: ${feeMX.toLocaleString()} MX (${DEX_CFG.withdraw.feePercent}%)\n` +
    `You receive: ${receiveMX.toLocaleString()} MX\n` +
    `Network gas: ${DEX_CFG.withdraw.gasTon} TON\n\n` +
    `Continue?`
  );
  if (!ok) return;

  const payload = {
    op: "withdraw_request",
    uid: UID,
    amountMX: amount,
    feeMX,
    receiveMX,
    gasTon: DEX_CFG.withdraw.gasTon,
    receiver: DEX_CFG.withdraw.receiver,
    wallet: state.wallet || {}
  };

  tg?.sendData?.(JSON.stringify(payload));
  tg?.showAlert?.("Withdraw request sent. Confirm payment in your wallet when bot replies.");

  tg?.HapticFeedback?.impactOccurred?.("light");
}

/* =========================
   REFERRAL: PERFECT START
   ========================= */
function getStartParam() {
  const sp1 = tg?.initDataUnsafe?.start_param;
  if (sp1) return String(sp1);

  try {
    const url = new URL(window.location.href);
    const sp2 = url.searchParams.get("start") || url.searchParams.get("startapp");
    if (sp2) return String(sp2);
  } catch(e){}

  return "";
}

function applyReferralOnce() {
  const usedKey = REF_CFG.cooldownKey(UID);
  const alreadyUsed = localStorage.getItem(usedKey) === "1";
  if (alreadyUsed) return;

  const startParam = getStartParam();
  if (!startParam) {
    localStorage.setItem(usedKey, "1");
    return;
  }

  const inviterId = String(startParam).replace(/[^0-9]/g, "");
  if (!inviterId) {
    localStorage.setItem(usedKey, "1");
    return;
  }

  if (inviterId === String(UID)) {
    localStorage.setItem(usedKey, "1");
    return;
  }

  state.balance += REF_CFG.levels[0].reward;
  state.ref.myInviter = inviterId;

  localStorage.setItem(REF_CFG.inviterKey(UID), inviterId);
  localStorage.setItem(usedKey, "1");
  localStorage.setItem(`mx_ref_state_${UID}`, JSON.stringify(state.ref));

  saveGameState();
  updateVisualStats();

  tg?.showAlert?.(`WELCOME BONUS: +${REF_CFG.levels[0].reward.toLocaleString()} MX`);
  tg?.HapticFeedback?.notificationOccurred?.("success");

  const payload = {
    op: "ref_new_user",
    newUserId: UID,
    inviterId: inviterId,
    levelRewards: REF_CFG.levels
  };
  tg?.sendData?.(JSON.stringify(payload));
}

/* =========================
   REFERRAL: SHARE (PHONE UI)
   ========================= */
async function shareReferralLink() {
  const link = REF_CFG.shareLink(UID);
  const text =
    `‚öîÔ∏è MATISOV X ‚Äî Cyber Samurai\n` +
    `Join the game in Telegram and get rewards.\n` +
    `My invite link: ${link}`;

  const shareData = { title: "MATISOV X", text, url: link };

  try {
    if (navigator.share) {
      await navigator.share(shareData);
      tg?.HapticFeedback?.notificationOccurred?.("success");
      return;
    }
  } catch(e){}

  try {
    await navigator.clipboard.writeText(link);
    tg?.showAlert?.("Invite link copied. Paste it anywhere.");
    tg?.HapticFeedback?.notificationOccurred?.("success");
    return;
  } catch(e){}

  const tempInput = document.createElement('input');
  tempInput.value = link;
  document.body.appendChild(tempInput);
  tempInput.select();
  document.execCommand('copy');
  document.body.removeChild(tempInput);

  tg?.showAlert?.("Invite link copied.");
  tg?.HapticFeedback?.notificationOccurred?.("success");
}

/* =========================
   MULTI-LEVEL MARKETING NOTE
   =========================
   Pure front-end cannot credit inviter balances safely.
   This block sends ref events to your bot via tg.sendData().
   Your bot must store referral tree + credit rewards server-side.
   ========================= */

function renderNeuralMissions() {
  const listContainer = document.getElementById('missions-render-list');
  if (!listContainer) return;
  listContainer.innerHTML = '';

  MISSION_DATABASE.forEach(mission => {
    const isDone = state.tasksDone.includes(mission.id);
    const card = document.createElement('div');
    card.className = `mission-row ${isDone ? 'opacity-40 grayscale pointer-events-none' : ''}`;

    card.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="text-3xl">${mission.icon}</div>
        <div>
          <div class="text-sm font-black uppercase text-white">${mission.title}</div>
          <div class="text-[10px] text-cyan-400 font-black tracking-widest">+1,000,000 MX</div>
        </div>
      </div>
      <button onclick="executeMissionLink('${mission.id}', '${mission.url}', ${mission.reward})"
        class="px-6 py-2 cyber-btn bg-cyan-500 text-black font-black text-[10px] rounded-lg">
        ${isDone ? 'COMPLETED' : 'VERIFY'}
      </button>
    `;
    listContainer.appendChild(card);
  });
}

function executeMissionLink(id, url, reward) {
  if (state.tasksDone.includes(id)) return;

  tg.openLink(url);
  aiSpeak(AI_DIALECTS[USER_LANG]?.taskDone || "Analyzing neural signature...");

  setTimeout(() => {
    state.balance += reward;
    state.tasksDone.push(id);

    localStorage.setItem(`mx_tasks_${UID}`, JSON.stringify(state.tasksDone));

    saveGameState();
    updateVisualStats();
    renderNeuralMissions();

    tg.showAlert(`AI SUCCESS: +${reward.toLocaleString()} MX`);
    tg.HapticFeedback.notificationOccurred('success');
  }, 4000);
}

function executeBurningUpgrade() {
  const upgradeCost = 500000;

  if (state.balance < upgradeCost) {
    tg.showAlert("NOT ENOUGH MX: Need 500,000 MX.");
    tg.HapticFeedback.notificationOccurred('error');
    return;
  }

  state.balance -= upgradeCost;
  state.burnedTotal = (state.burnedTotal || 0) + upgradeCost;
  state.power = Number(state.power || 1) + 2.5;

  aiSpeak(AI_DIALECTS[USER_LANG]?.upgrade || "Burn complete. Power Overclocked.");

  document.body.style.filter = 'invert(1) hue-rotate(180deg)';
  setTimeout(() => document.body.style.filter = '', 200);

  tg.HapticFeedback.notificationOccurred('success');
  updateVisualStats();
  saveGameState();
}

/* =========================
   SCREEN SWITCHER
   ========================= */
function switchSystemScreen(screenId) {
  const allScreens = document.querySelectorAll('.game-screen');
  allScreens.forEach(s => s.classList.remove('screen-visible'));

  const allNavs = document.querySelectorAll('.nav-trigger');
  allNavs.forEach(n => n.classList.remove('nav-active'));

  if (screenId !== 'battle') {
    const target = document.getElementById(`screen-${screenId}`);
    if (target) target.classList.add('screen-visible');
  }

  const activeNav = document.getElementById(`btn-nav-${screenId}`);
  if (activeNav) activeNav.classList.add('nav-active');

  if (screenId === 'missions') renderNeuralMissions();

  if (screenId === 'profile') {
    const claimEl = document.getElementById("ui-claimable");
    if (claimEl) claimEl.textContent = Math.floor(computeClaimableNow().claimable).toLocaleString() + " MX";
  }

  tg.HapticFeedback.impactOccurred('light');
}

/* =========================
   OPTIONAL: HOOK BUTTONS
   =========================
   In your HTML user menu add buttons with these IDs:
   - btn-claim
   - btn-share-ref
   - btn-open-dex
   - btn-open-wallets
   - btn-withdraw
   and a label span:
   - ui-claimable
   ========================= */
function bindMenuButtons() {
  const bClaim = document.getElementById("btn-claim");
  if (bClaim) bClaim.onclick = claimCoins;

  const bShare = document.getElementById("btn-share-ref");
  if (bShare) bShare.onclick = shareReferralLink;

  const bDex = document.getElementById("btn-open-dex");
  if (bDex) bDex.onclick = openDexList;

  const bWallets = document.getElementById("btn-open-wallets");
  if (bWallets) bWallets.onclick = openWalletList;

  const bWithdraw = document.getElementById("btn-withdraw");
  if (bWithdraw) bWithdraw.onclick = requestWithdrawMX;
}

/* =========================
   AUDIO TAP
   ========================= */
function playCyberSound(type) {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  if (type === 'tap') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
  }
}

const clickTrigger = document.getElementById('combat-click-trigger');
if (clickTrigger) clickTrigger.addEventListener('pointerdown', () => playCyberSound('tap'));

/* =========================
   FINAL BOOT
   ========================= */
window.addEventListener('DOMContentLoaded', () => {
  try {
    applyReferralOnce();
    bindMenuButtons();
    tickClaimable();
    setInterval(tickClaimable, 1500);

    initNeuralCore();
    console.log("Matisov X Engine: Block 3 Operational");
  } catch (e) {
    console.error("Block 3 Error:", e);
  }
});
</script>
```Ó®Å0Ó®Ç
